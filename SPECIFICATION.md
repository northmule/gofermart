## Накопительная система лояльности "Гофермарт"

### Общие требования

Система представляет собой HTTP API со следующими требованиями к бизнес-логике:

- регистрация, аутентификация и авторизация пользователей
- прием номеров заказов от зарегистрированных пользователей
- учет и ведение списка переданных номеров заказов зарегистрированного пользователя
- учет и ведение накопительного счета зарегистрированного пользователя
- проверка принятых номеров заказов через систему расчета баллов лояльности
- начисление за каждый подходящий номер заказа положенного вознаграждения на счет лояльности пользователя

### Абстрактная схема взаимодействия с системой

Ниже представлена абстрактная бизнес логика взимодействия пользователя с системой:

1. пользователь регистрируется в системе лояльности "Гофермарт"
2. пользователь совершает покупку в интернет-магазине "Гофермарт"
3. заказ попадает в систему расчета баллов лояльности
4. пользователь передает номер совершенного заказа в систему лояльности
5. система связывает номер заказа с пользователем и сверяет номер с системой расчета баллов лояльности
6. при наличии положительного расчета баллов лояльности производится начисление баллов лояльности на счет пользователя
7. пользователь списывает доступные баллы лояльности для частичной или полной оплаты последующих заказов в
   интернет-магазине "Гофермарт"

Примечание: пункт 2 схемы представлен как гипотетический и не требует реализации в данной работе. Пункт 3 реализован в
системе расчета баллов лояльности и не требует реализации в данной работе

### Система расчета баллов лояльности

Система расчета баллов лояльности является внешним сервисом в доверенном контуре. Он работает по принципу черного ящика
и недоступен для инспекции внешними клиентами. Система расчитывает положенные баллы лояльности за совершенный заказ по
сложным алгоритмам, которые могут меняться в любой момент времени.

Внешнему потребителю доступна только информация о кол-ве положенных за конкретный заказ баллов лояльности. Причины
наличия или отсутствия начислений внешнему потребителю неизвестны.

Протокол взаимодействия с сервисом базы будет предоставлен в конце.

### Сводное HTTP API

Накопительная система лояльности "Гофермарт" должна предоставлять следующие HTTP хендлеры:

- `POST /api/user/register` - регистрация пользователя
- `POST /api/user/login` - аутентификация пользователя
- `POST /api/user/orders` - загрузка пользователем номера заказа для расчета
- `GET /api/user/orders` - получение списка загруженных пользователем номеров заказов, статусов их обработки и
  информации о начислениях
- `GET /api/user/balance` - получение текущего баланса счета баллов лояльности пользователя
- `POST /api/user/balance/withdraw` - запрос на списание баллов с накопительного счета в счет оплаты нового заказа
- `GET /api/user/balance/withdrawals` - получение информации о выводе средств с призового счета пользователем

### Общие ограничения и требования

- хранилище данных - PostgreSQL
- структура таблиц остается на усмотрение студента
- типы и формат хранения данных (в том числе паролей и прочей чувствительной информации) остается на усмотрение студента
- клиент может поддерживать HTTP запросы/ответы со сжатием данных
- клиент не обязан делать запросы соответственно нижеизложенной спецификации API, любая проверка запроса остается на
  усмотрение студента
- формат и алгоритм проверки аутентификации и авторизации пользователя остается на усмотрение студента
- номера заказов уникальны и никогда не повторяются
- номер заказа может быть принят в обработку только один раз от одного пользователя
- номер заказа может не иметь никакого начисления
- вознаграждение начисляется и тратится в виртуальных баллах из расчета 1 балл = 1 рубль

#### Регистрация пользователя

Хендлер: `POST /api/user/register`

Регистрация производится по паре логин/пароль. Каждый логин должен быть уникальным. После успешной регистрации должна
происходить автоматическая аутентификация пользователя.

Формат запроса:

```
POST /api/user/register HTTP/1.1
Content-Type: application/json
...

{
	"login": "<login>",
	"password": "<password>"
}
```

Возможные коды ответа:

- `200` - пользователь успешно зарегистрирован и аутентифицирован
- `400` - не верный формат запроса
- `409` - логин уже занят
- `500` - внутренняя ошибка сервера

#### Аутентификация пользователя

Хендлер: `POST /api/user/login`

Аутентификация производится по паре логин/пароль.

Формат запроса:

```
POST /api/user/login HTTP/1.1
Content-Type: application/json
...

{
	"login": "<login>",
	"password": "<password>"
}
```

Возможные коды ответа:

- `200` - пользователь успешно аутентифицирован
- `400` - не верный формат запроса
- `401` - не верная пара логин/пароль
- `500` - внутренняя ошибка сервера

#### Загрузка номера заказа

Хендлер: `POST /api/user/orders`

Хендлер доступен только аутентифицированным пользователям. Номером заказа является последовательность цифр произвольной
длины. Номер заказа может быть проверен на корректность ввода с
помощью [алгоритма Луна](https://ru.wikipedia.org/wiki/Алгоритм_Луна).

Формат запроса:

```
POST /api/user/orders HTTP/1.1
Content-Type: text/plain
...

12345678903
```

Возможные коды ответа:

- `200` - номер заказа уже был загружен этим пользователем
- `202` - новый номер заказа принят в обработку
- `400` - не верный формат запроса
- `401` - пользователь не аутентифицирован
- `409` - номер заказа уже был загружен другим пользователем
- `422` - не верный формат номер заказа
- `500` - внутренняя ошибка сервера

#### Получение списка загруженных номеров заказов

Хендлер: `GET /api/user/orders`

Хендлер доступен только авторизованному пользователю. Номера заказа в выдаче должны быть отсортированы по времени
загрузки от самых старых к самым новым. Формат даты - RFC3339.

Доступные статусы обработки расчетов:

- `NEW` - заказ загружен в систему, но не попал в обработку
- `PROCESSING` - вознаграждение за заказ расчитывается
- `INVALID` - система расчета вознаграждений отказала в расчете
- `PROCESSED` - данные по заказу проверены и информация о расчете успешно получена

Формат запроса:

```
GET /api/user/tickets HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` - успешная обработка запроса

  Формат ответа:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    [
    	{
            "number": 9278923470,
            "status": "PROCESSED",
            "accrual": 500,
            "uploaded_at": "2020-12-10T15:15:45+03:00"
        },
        {
            "number": 12345678903,
            "status": "PROCESSING",
            "uploaded_at": "2020-12-10T15:12:01+03:00"
        },
        {
            "number": 346436439,
            "status": "INVALID",
            "uploaded_at": "2020-12-09T16:09:53+03:00"
        }
    ]
    ```

- `204` - нет данных для ответа
- `401` - пользователь не авторизован
- `500` - внутренняя ошибка сервера

#### Получение текущего баланса пользователя

Хендлер: `GET /api/user/balance`

Хендлер доступен только авторизованному пользователю. В ответе должны содержаться данные о текущей сумме баллов
лояльности, а также сумме использованных за весь период регистрации баллов.

Формат запроса:

```
GET /api/user/balance HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` - успешная обработка запроса

  Формат ответа:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    {
    	"current": 500.5,
    	"withdrawn": 42
    }
    ```

- `401` - пользователь не авторизован
- `500` - внутренняя ошибка сервера

#### Запрос на списание средств

Хендлер: `POST /api/user/balance/withdraw`

Хендлер доступен только авторизованному пользователю. По факту запроса выводится вся сумма доступная на счету. Вывод
производится только на номер банковской карты.

Примечание: для успешного списания достаточно успешной регистрации запроса, никаких внешних систем начисления не
предусмотрено и не требуется реализовывать.

Формат запроса:

```
GET /api/user/withdrawals HTTP/1.1
Content-Type: application/json

{
	"order": "2377225624",
    "sum": 751
}
```

где `order` - номер заказа, а `sum` - сумма баллов к списанию в счет оплаты

Возможные коды ответа:

- `200` - успешная обработка запроса
- `401` - пользователь не авторизован
- `402` - на счету недостаточно средств
- `422` - не верный номер заказа
- `500` - внутренняя ошибка сервера

#### Получение информации о выводе средств

Хендлер: `GET /api/user/balance/withdrawals`

Хендлер доступен только авторизованному пользователю. Факты выводов в выдаче должны быть отсортированы по времени вывода
от самых старых к самым новым. Формат даты - RFC3339.

Формат запроса:

```
GET /api/user/withdrawals HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` - успешная обработка запроса

  Формат ответа:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    [
        {
            "order": "2377225624",
            "sum": 500,
            "status": "PROCESSED",
            "processed_at": "2020-12-09T16:09:57+03:00"
        }
    ]
    ```

- `401` - пользователь не авторизован
- `500` - внутренняя ошибка сервера

### Взаимодействие с системой расчета начислений баллов лояльности

Для взаимодействия с системой доступен один хендлер:

- `GET /api/orders/{number}` - получение информации о расчете начислений баллов лояльности

Формат запроса:

```
GET /api/orders/{number} HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` - успешная обработка запроса

  Формат ответа:

    ```
    200 OK HTTP/1.1
    Content-Type: application/json
    ...
    
    [
        {
            "order": "<number>",
            "status": "PROCESSED",
            "accrual": 500
        }
    ]
    ```

  Поля объекта ответа:

    - `order` - номер заказа
    - `status` - статус расчета начисления:
        - `REGISTERED` - заказ зарегистрирован, но не начисление не расчитано
        - `INVALID` - заказ не принят к расчету и вознаграждение не будет начислено
        - `PROCESSING` - расчет начисления в процессе
        - `PROCESSED` - расчет начисления окончен
    - `accrual` - расчитанные баллы к начислению. При отсутствии начисления - поле отсутствует в ответе

- `429` - превышено кол-во запросов к сервису

  Формат ответа:

    ```
    429 Too Many Requests HTTP/1.1
    Content-Type: text/plain
    Retry-After: 60
    
    No more than N requests per minute allowed
    ```

- `500` - внутренняя ошибка сервера

Заказ может быть взят в расчет в любой момент после его совершения, время выполнения расчета системой не
регламентировано. Статусы `INVALID` и `PROCESSED` являются окончательными.

Общее количество запросов за информацией о начислении не ограничено.

Адрес системы расчета начилений может быть передан серверу системы лояльности "Гофермарт" через переменную окружения
ОС `ACCRUAL_SYSTEM_ADDRESS` или через флаг `-a`.